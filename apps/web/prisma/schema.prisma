generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                                   String                   @id @default(uuid()) @map("id")
  email                                String                   @unique
  passwordHash                         String?                  @map("password_hash")
  firstName                            String?                  @map("first_name")
  lastName                             String?                  @map("last_name")
  role                                 UserRole                 @default(STUDENT)
  avatar                               String?
  bio                                  String?
  isActive                             Boolean                  @default(true) @map("is_active")
  lastLoginAt                          DateTime?                @map("last_login_at")
  emailVerified                        DateTime?                @map("email_verified")
  createdAt                            DateTime                 @default(now()) @map("created_at")
  updatedAt                            DateTime                 @updatedAt @map("updated_at")

  // NextAuth relations
  accounts                             Account[]
  sessions                             Session[]

  // Existing relations
  ParentStudent_ParentStudent_ATousers ParentStudent[]          @relation("ParentStudent_ATousers")
  ParentStudent_ParentStudent_BTousers ParentStudent[]          @relation("ParentStudent_BTousers")
  assignment_submissions               assignment_submissions[]
  enrollments                          CourseEnrollment[]
  coursesOwned                         Course[]                 @relation("CourseInstructor")
  gardenRewards                        GardenReward[]
  gardens                              Garden[]
  ieps                                 Iep[]
  lesson_progress                      lesson_progress[]
  refresh_tokens                       refresh_tokens[]
  user_profiles                        user_profiles?

  @@map("users")
}

// ============== NEXTAUTH ==============

model Account {
  id                String  @id @default(uuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Curriculum {
  id          String           @id @default(uuid())
  title       String
  description String?
  gradeLevel  String           @map("grade_level")
  subject     String
  status      CurriculumStatus @default(DRAFT)
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")
  courses     Course[]

  @@map("curricula")
}

model Course {
  id           String             @id @default(uuid())
  title        String
  description  String?
  instructorId String             @map("instructor_id")
  curriculumId String?            @map("curriculum_id")
  duration     Int?
  status       CourseStatus       @default(DRAFT)
  thumbnailUrl String?            @map("thumbnail_url")
  createdAt    DateTime           @default(now()) @map("created_at")
  updatedAt    DateTime           @updatedAt @map("updated_at")
  assignments  Assignment[]
  enrollments  CourseEnrollment[]
  curriculum   Curriculum?        @relation(fields: [curriculumId], references: [id])
  instructor   User               @relation("CourseInstructor", fields: [instructorId], references: [id])
  lessons      Lesson[]

  @@map("courses")
}

model Lesson {
  id              String            @id @default(uuid())
  courseId        String            @map("course_id")
  title           String
  content         String?
  orderIndex      Int               @map("order_index")
  duration        Int?
  type            LessonType        @default(TEXT)
  status          LessonStatus      @default(DRAFT)
  videoUrl        String?           @map("video_url")
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  lesson_progress lesson_progress[]
  course          Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@map("lessons")
}

model Assignment {
  id                     String                   @id @default(uuid())
  courseId               String                   @map("course_id")
  title                  String
  description            String?
  dueDate                DateTime?                @map("due_date")
  maxPoints              Int                      @default(100) @map("max_points")
  status                 AssignmentStatus         @default(DRAFT)
  createdAt              DateTime                 @default(now()) @map("created_at")
  updatedAt              DateTime                 @updatedAt @map("updated_at")
  assignment_submissions assignment_submissions[]
  course                 Course                   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@map("assignments")
}

model CourseEnrollment {
  id          String    @id @default(uuid())
  courseId    String    @map("course_id")
  studentId   String    @map("student_id")
  progress    Float     @default(0)
  enrolledAt  DateTime  @default(now()) @map("enrolled_at")
  completedAt DateTime? @map("completed_at")
  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student     User      @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([courseId, studentId])
  @@map("course_enrollments")
}

model Iep {
  id             String    @id @default(uuid())
  studentId      String    @map("student_id")
  title          String
  description    String?
  accommodations String[]
  startDate      DateTime  @map("start_date")
  endDate        DateTime  @map("end_date")
  status         IEPStatus @default(DRAFT)
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  goals          IepGoal[]
  student        User      @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("ieps")
}

model IepGoal {
  id          String        @id @default(uuid())
  iepId       String        @map("iep_id")
  description String
  targetDate  DateTime      @map("target_date")
  progress    Float         @default(0)
  status      IEPGoalStatus @default(NOT_STARTED)
  notes       String?
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")
  iep         Iep           @relation(fields: [iepId], references: [id], onDelete: Cascade)

  @@map("iep_goals")
}

model Garden {
  id          String   @id @default(uuid())
  studentId   String   @map("student_id")
  name        String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  student     User     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  plants      Plant[]

  @@map("gardens")
}

model Plant {
  id          String         @id @default(uuid())
  gardenId    String         @map("garden_id")
  name        String
  type        GardenItemType @default(PLANT)
  level       Int            @default(1)
  xp          Int            @default(0)
  health      Int            @default(100)
  lastWatered DateTime?      @map("last_watered")
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")
  garden      Garden         @relation(fields: [gardenId], references: [id], onDelete: Cascade)

  @@map("plants")
}

model GardenReward {
  id         String     @id @default(uuid())
  studentId  String     @map("student_id")
  rewardType RewardType @map("reward_type")
  amount     Int        @default(1)
  reason     String
  earnedAt   DateTime   @default(now()) @map("earned_at")
  student    User       @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("garden_rewards")
}

model ParentStudent {
  A                            String
  B                            String
  users_ParentStudent_ATousers User   @relation("ParentStudent_ATousers", fields: [A], references: [id], onDelete: Cascade)
  users_ParentStudent_BTousers User   @relation("ParentStudent_BTousers", fields: [B], references: [id], onDelete: Cascade)

  @@id([A, B], map: "_ParentStudent_AB_pkey")
  @@index([B], map: "_ParentStudent_B_index")
  @@map("_ParentStudent")
}

model assignment_submissions {
  id            String     @id
  assignment_id String
  student_id    String
  content       String?
  file_url      String?
  score         Float?
  feedback      String?
  submitted_at  DateTime   @default(now())
  graded_at     DateTime?
  assignments   Assignment @relation(fields: [assignment_id], references: [id], onDelete: Cascade)
  users         User       @relation(fields: [student_id], references: [id], onDelete: Cascade)

  @@unique([assignment_id, student_id])
}

model lesson_progress {
  id           String    @id
  lesson_id    String
  student_id   String
  completed    Boolean   @default(false)
  score        Float?
  started_at   DateTime  @default(now())
  completed_at DateTime?
  lessons      Lesson    @relation(fields: [lesson_id], references: [id], onDelete: Cascade)
  users        User      @relation(fields: [student_id], references: [id], onDelete: Cascade)

  @@unique([lesson_id, student_id])
}

model refresh_tokens {
  id         String   @id
  user_id    String
  token      String   @unique
  expires_at DateTime
  created_at DateTime @default(now())
  users      User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model user_profiles {
  id          String   @id
  user_id     String   @unique
  preferences Json?
  settings    Json?
  created_at  DateTime @default(now())
  updated_at  DateTime
  users       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

enum CurriculumStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum CourseStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum LessonType {
  VIDEO
  TEXT
  QUIZ
  ASSIGNMENT
}

enum LessonStatus {
  DRAFT
  PUBLISHED
}

enum AssignmentStatus {
  DRAFT
  PUBLISHED
  CLOSED
}

enum RewardType {
  SEED
  FERTILIZER
  DECORATION
  XP
}

enum GardenItemType {
  FLOWER
  TREE
  PLANT
  DECORATION
}

enum IEPGoalStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

enum IEPStatus {
  DRAFT
  ACTIVE
  COMPLETED
  ARCHIVED
}

enum UserRole {
  STUDENT
  TEACHER
  ADMIN
  PARENT
}
